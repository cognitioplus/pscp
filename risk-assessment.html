<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Risk Assessment Workbench (Command Center Style)</title>
    
    <!-- Google Fonts Imports -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

    <!-- Tailwind Config for Custom Colors and Inter Font -->
    <script>
        (function() {
            if (typeof tailwind !== 'undefined') {
                tailwind.config = {
                    theme: {
                        extend: {
                            fontFamily: {
                                sans: ['Inter', 'sans-serif'],
                                poppins: ['Poppins', 'sans-serif'],
                                roboto: ['Roboto Condensed', 'sans-serif'],
                            },
                            colors: {
                                primary: '#00f7ff',
                                secondary: '#e5e7eb',
                                danger: '#ef4444',
                                warning: '#f97316',
                                safe: '#10b981',
                                context: '#111827',
                                background: '#0f0f0f',
                            }
                        }
                    }
                }
            }
        })();
    </script>

    <style>
        /* Global Body Font and Background – improved contrast */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f0f0f;
            color: #e6e6e6;
            background-image: radial-gradient(circle at 50% 10%, rgba(0, 247, 255, 0.03), transparent 70%);
            margin: 0;
            padding: 0;
        }

        /* --- High-Contrast Custom Scrollbar --- */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 5px;
            border: 2px solid #1a1a1a;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* --- Chart Container Specifics (MANDATORY) --- */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 400px;
            max-height: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }

        /* --- Interactive Card Hover Effects (MANDATORY) --- */
        .interactive-card {
            background-color: #171717;
            border: 1px solid #374151;
            transition: all 0.3s ease;
        }

        .interactive-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 247, 255, 0.15);
            border-color: #00f7ff;
        }

        .interactive-card:focus-within {
            outline: 2px solid #00f7ff;
            outline-offset: 2px;
        }

        /* --- Timeline Connector Lines (MANDATORY) --- */
        .timeline-line::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 2px;
            background-color: #4b5563;
            z-index: 0;
            transform: translateX(-50%);
        }

        /* High-Contrast Risk Level Tags */
        .risk-high { 
            background-color: #7f1d1d; 
            color: #fecaca; 
            font-weight: 700; 
            padding: 4px 8px; 
            border-radius: 4px; 
            border: 1px solid #b91c1c; 
        } 
        .risk-medium { 
            background-color: #7c2d12; 
            color: #fed7aa; 
            font-weight: 700; 
            padding: 4px 8px; 
            border-radius: 4px; 
            border: 1px solid #c2410c; 
        }
        .risk-low { 
            background-color: #042f2e; 
            color: #ccfbf1; 
            font-weight: 700; 
            padding: 4px 8px; 
            border-radius: 4px; 
            border: 1px solid #0d9488; 
        }
        .risk-vlow { 
            background-color: #1e293b; 
            color: #e2e8f0; 
            font-weight: 700; 
            padding: 4px 8px; 
            border-radius: 4px; 
            border: 1px solid #334155; 
        }

        /* Form Controls */
        input[type="text"],
        textarea,
        select {
            border-radius: 0.375rem;
            border: 1px solid #374151;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            width: 100%;
            background-color: #111827;
            color: #f1f5f9;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-family: 'Inter', sans-serif;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #00f7ff;
            box-shadow: 0 0 0 2px rgba(0, 247, 255, 0.4);
        }

        /* Table Rows */
        #risk-table tbody tr {
            background-color: #111827;
            border-bottom: 1px solid #1f2937;
        }

        #risk-table tbody tr:hover {
            background-color: #1e293b;
        }

        /* Headers */
        h3 {
            color: #00f7ff;
            text-shadow: 0 0 8px rgba(0, 247, 255, 0.2);
        }

        /* Sidebar */
        #sidebar {
            background-color: #111827 !important;
            border-right: 1px solid #374151;
        }

        .nav-item {
            color: #d1d5db;
        }

        .nav-item:hover,
        .nav-item.active-nav {
            color: #f9fafb;
            background-color: #1f2937;
            border-left-color: #00f7ff !important;
        }

        /* Text colors for readability */
        .text-gray-400 {
            color: #9ca3af !important;
        }

        .text-gray-200 {
            color: #e5e7eb !important;
        }

        /* Focus visibility */
        button:focus,
        .nav-item:focus {
            outline: 2px solid #00f7ff;
            outline-offset: 2px;
        }

        /* Section Transition */
        .content-section {
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }
        .content-section.hidden {
            display: none;
            opacity: 0;
        }

        /* Sidebar overlay for mobile */
        .backdrop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(15, 15, 15, 0.85);
            z-index: 30;
            transition: opacity 0.3s;
            opacity: 0;
            pointer-events: none;
        }
        .backdrop-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="text-gray-200 antialiased h-screen flex overflow-hidden">

    <!-- Backdrop for Mobile Sidebar -->
    <div id="backdrop" class="backdrop-overlay" onclick="toggleMobileMenu()"></div>

    <!-- Mobile Menu Button -->
    <button id="mobile-menu-btn" class="md:hidden fixed top-4 right-4 z-50 bg-context text-primary p-3 rounded-full shadow-lg border-2 border-primary/50 hover:bg-gray-700 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
    </button>

    <!-- Sidebar Navigation (Fixed on Desktop) -->
    <aside id="sidebar" class="bg-gray-800 text-gray-100 w-64 flex-shrink-0 flex flex-col transition-transform duration-300 transform -translate-x-full md:translate-x-0 fixed md:sticky top-0 h-full z-40 border-r border-primary/50 shadow-2xl shadow-primary/10">
        <div class="p-6 border-b border-primary/50 bg-gray-900 shadow-xl">
            <h1 class="text-2xl font-poppins tracking-widest text-primary">PSCP <span class="text-white">RISK CMD</span></h1>
            <p class="text-xs text-gray-400 mt-1 font-sans">ISO 31000 Workbench</p>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-4">
            <ul class="space-y-1">
                <li>
                    <button onclick="navTo('context')" class="nav-item w-full text-left px-6 py-3 flex items-center gap-3 hover:bg-gray-700 transition-colors border-l-4 border-primary/0 active-nav bg-gray-700 border-l-4 border-primary rounded-r-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary lucide lucide-git-branch"><line x1="6" x2="6" y1="3" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9c-3.88 0-7.35 1.72-9.6 4.34"/></svg>
                        <span class="font-semibold text-sm">Context Establishment</span>
                    </button>
                </li>
                <li>
                    <button onclick="navTo('assessment')" class="nav-item w-full text-left px-6 py-3 flex items-center gap-3 hover:bg-gray-700 transition-colors border-l-4 border-primary/0 rounded-r-full" id="nav-assessment">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary lucide lucide-bar-chart-3"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                        <span class="font-semibold text-sm">Risk Assessment</span>
                    </button>
                </li>
                <li>
                    <button onclick="navTo('evaluation')" class="nav-item w-full text-left px-6 py-3 flex items-center gap-3 hover:bg-gray-700 transition-colors border-l-4 border-primary/0 rounded-r-full" id="nav-evaluation">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary lucide lucide-shield-check"><path d="M20 13c0 5-8 7-8 7s-8-2-8-7V5l8-3 8 3z"/><path d="m9 12 2 2 4-4"/></svg>
                        <span class="font-semibold text-sm">Control Evaluation</span>
                    </button>
                </li>
                <li>
                    <button onclick="navTo('review')" class="nav-item w-full text-left px-6 py-3 flex items-center gap-3 hover:bg-gray-700 transition-colors border-l-4 border-primary/0 rounded-r-full" id="nav-review">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary lucide lucide-line-chart"><path d="M3 3v18h18"/><path d="m18 12-6-6-4 4-3-3"/></svg>
                        <span class="font-semibold text-sm">Migration & Review</span>
                    </button>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content Area -->
    <div class="flex-1 overflow-y-auto w-full md:ml-0">
        <!-- Sticky Header -->
        <header class="sticky top-0 z-10 bg-gray-900/90 backdrop-blur-sm border-b border-primary/30 p-4 md:p-6 shadow-xl">
            <h2 class="text-3xl font-poppins text-primary tracking-wide">Integrated Risk Assessment Workbench</h2>
            <p class="mt-1 text-gray-400 max-w-4xl text-sm font-sans">
                ISO 31000-aligned approach focused on control effectiveness and risk migration.
            </p>
        </header>

        <!-- Scrollable Main Body -->
        <main class="relative w-full p-6 md:p-10" id="main-scroll">
            <div class="max-w-7xl mx-auto">
                
                <!-- SECTION 1: CONTEXT ESTABLISHMENT -->
                <section id="context" class="content-section">
                    <h3 class="text-2xl font-poppins text-primary mb-6 pb-2 border-b border-primary/30">1. Context Establishment (Scope & Criteria)</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-context p-8 rounded-xl shadow-2xl border border-primary/50 interactive-card">
                            <h4 class="font-poppins text-xl mb-4 text-gray-100 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary lucide lucide-compass"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg> Organizational Scope</h4>
                            <p class="text-sm text-gray-400 mb-6 font-sans">Define the boundaries and critical functions under assessment for continuity planning.</p>
                            
                            <label class="block text-sm font-semibold text-gray-400 mb-1">Assessment Name</label>
                            <input type="text" id="assessment-name" value="PSCP Q3 Risk Review" class="mb-6">
                            
                            <label class="block text-sm font-semibold text-gray-400 mb-1">Critical Function Assessed</label>
                            <textarea id="assessment-scope" rows="4" class="w-full">Emergency Response and Public Notification Services, including IT Infrastructure and Key Personnel availability.</textarea>

                            <button onclick="navTo('assessment')" class="mt-8 bg-primary text-gray-900 px-6 py-3 rounded-xl font-poppins font-bold hover:bg-cyan-400 transition shadow-lg shadow-primary/30">
                                Begin Assessment →
                            </button>
                        </div>

                        <div class="bg-context p-6 rounded-xl shadow-2xl border border-warning/50 interactive-card">
                            <h4 class="font-poppins text-xl mb-4 text-gray-100 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-warning lucide lucide-scaling"><path d="M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18Z"/><path d="M7 10h5v5"/></svg>Risk Evaluation Criteria (5x5)</h4>
                            <p class="text-sm text-gray-400 mb-4 font-sans">Inherent Risk Score = Likelihood (L) x Impact (I). Max: 25.</p>
                            
                            <!-- Risk Matrix Display -->
                            <div class="grid grid-cols-6 gap-px text-center text-xs font-semibold border-2 border-primary bg-gray-900 overflow-hidden rounded-lg">
                                <div class="col-span-1 bg-gray-800 text-primary p-1 border-r border-primary">L/I</div>
                                <div class="col-span-1 bg-gray-800 text-primary p-1">1 (Insig)</div>
                                <div class="col-span-1 bg-gray-800 text-primary p-1">2 (Minor)</div>
                                <div class="col-span-1 bg-gray-800 text-primary p-1">3 (Mod)</div>
                                <div class="col-span-1 bg-gray-800 text-primary p-1">4 (Major)</div>
                                <div class="col-span-1 bg-gray-800 text-primary p-1">5 (Catas)</div>

                                <div class="col-span-1 bg-gray-800 text-primary p-1 border-r border-primary">5 (Almost C.)</div>
                                <div class="col-span-5 grid grid-cols-5 text-secondary">
                                    <div class="p-1 risk-medium">5</div>
                                    <div class="p-1 risk-high">10</div>
                                    <div class="p-1 risk-high">15</div>
                                    <div class="p-1 risk-high">20</div>
                                    <div class="p-1 risk-high">25</div>
                                </div>

                                <div class="col-span-1 bg-gray-800 text-primary p-1 border-r border-primary">3 (Possible)</div>
                                <div class="col-span-5 grid grid-cols-5 text-secondary">
                                    <div class="p-1 risk-low">3</div>
                                    <div class="p-1 risk-medium">6</div>
                                    <div class="p-1 risk-medium">9</div>
                                    <div class="p-1 risk-high">12</div>
                                    <div class="p-1 risk-high">15</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SECTION 2 & 3: RISK ASSESSMENT & CONTROL EVALUATION -->
                <section id="assessment" class="content-section hidden">
                    <h3 class="text-2xl font-poppins text-primary mb-6 pb-2 border-b border-primary/30">2. Assessment & 3. Control Evaluation</h3>
                    <p class="text-gray-400 mb-6 text-sm font-sans">
                        Evaluate <strong>Inherent Risk</strong> (before controls) and then rate existing control effectiveness to calculate the <strong>Residual Risk</strong> (risk remaining).
                    </p>

                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 font-sans mb-8">
                        <div class="bg-context p-5 rounded-xl shadow-xl border-l-4 border-danger/80 hover:shadow-danger/20 transition-shadow interactive-card">
                            <p class="text-xs uppercase text-gray-400 font-semibold flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-danger lucide lucide-alert-triangle"><path d="m21.73 18-9-15-9 15z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg> High Inherent Risks (Score > 12)</p>
                            <p id="high-risk-count" class="text-4xl font-poppins text-danger mt-1">0</p>
                        </div>
                        <div class="bg-context p-5 rounded-xl shadow-xl border-l-4 border-warning/80 hover:shadow-warning/20 transition-shadow interactive-card">
                            <p class="text-xs uppercase text-gray-400 font-semibold flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-warning lucide lucide-gauge"><path d="M20.1 9a9 9 0 1 0-16.2 0"/><path d="M12 14v4"/><path d="M10.5 4.5l3 3"/></svg> Average Control Effectiveness</p>
                            <p id="avg-control-eff" class="text-4xl font-poppins text-warning mt-1">0 / 5.0</p>
                        </div>
                        <div class="bg-context p-5 rounded-xl shadow-xl border-l-4 border-safe/80 hover:shadow-safe/20 transition-shadow interactive-card">
                            <p class="text-xs uppercase text-gray-400 font-semibold flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-safe lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg> Risks Migrated to Low (Residual Score < 6)</p>
                            <p id="migrated-risk-count" class="text-4xl font-poppins text-safe mt-1">0</p>
                        </div>
                    </div>
                    
                    <!-- Risk Table -->
                    <div class="bg-context p-6 rounded-xl shadow-2xl border border-primary/50 overflow-x-auto mb-6">
                        <table id="risk-table" class="min-w-full divide-y divide-gray-700 font-sans">
                            <thead class="bg-gray-800 text-xs uppercase tracking-wider text-primary sticky top-0 z-5">
                                <tr>
                                    <th class="px-3 py-3 text-left">Hazard/Threat</th>
                                    <th class="px-3 py-3 text-left w-24">L (1-5)</th>
                                    <th class="px-3 py-3 text-left w-24">I (1-5)</th>
                                    <th class="px-3 py-3 text-center w-24">Inherent</th>
                                    <th class="px-3 py-3 text-left">Controls / Treatment</th>
                                    <th class="px-3 py-3 text-center w-28">Eff (1-5)</th>
                                    <th class="px-3 py-3 text-center w-24">Residual</th>
                                    <th class="px-3 py-3 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="risk-body" class="divide-y divide-gray-700 text-sm text-gray-300">
                                <!-- Rows generated by JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Add Risk Section -->
                    <div class="p-4 bg-gray-800 rounded-xl border border-primary/30 shadow-lg interactive-card">
                        <div class="flex flex-col sm:flex-row gap-4 items-center">
                            <input type="text" id="new-hazard" placeholder="Enter new hazard (e.g., Data Breach via API Misconfiguration)" class="flex-1">
                            <button onclick="addRisk()" class="w-full sm:w-auto bg-primary text-gray-900 px-6 py-2 rounded-xl font-poppins font-bold hover:bg-cyan-400 transition shrink-0 shadow-md shadow-primary/50">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1 lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                                Add Risk
                            </button>
                        </div>
                    </div>
                    <button onclick="navTo('review')" class="mt-6 bg-warning text-gray-900 px-6 py-3 rounded-xl font-poppins font-bold hover:bg-orange-400 transition shadow-lg shadow-warning/30 float-right">
                        Review Migration →
                    </button>
                    <div class="clearfix"></div>
                </section>

                <!-- SECTION 4: MIGRATION & REVIEW -->
                <section id="review" class="content-section hidden">
                    <h3 class="text-2xl font-poppins text-primary mb-6 pb-2 border-b border-primary/30">4. Risk Migration & Review</h3>
                    <p class="text-gray-400 mb-8 text-sm font-sans">
                        Review the risk migration from Inherent to Residual risk (Top 5). Large gaps indicate effective controls, while small gaps highlight areas requiring new <strong>Treatment Plans</strong>.
                    </p>

                    <!-- Chart Container -->
                    <div class="chart-container bg-context p-6 rounded-xl shadow-2xl border border-primary/50 interactive-card">
                        <canvas id="migrationChart"></canvas>
                    </div>

                    <div class="mt-8 p-6 bg-context rounded-xl border border-primary/30 shadow-lg interactive-card">
                        <h4 class="font-poppins text-xl mb-3 text-primary flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary lucide lucide-lightbulb"><path d="M15 14c.2-.58.2-1.2 0-2c-.2-.58-.5-1.07-1-1.42V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v6.58c-.5.35-.8 1.05-1 1.42-.2.58-.2 1.2 0 2a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2z"/><path d="M12 21h4"/></svg> Recommendations</h4>
                        <p class="text-sm text-gray-300 leading-relaxed">
                            Focus immediate attention on risks where the <strong>Residual Risk Score</strong> remains above 9. These are the highest priority items for developing detailed, resource-allocated <strong>Treatment Plans</strong> to further mitigate continuity threats.
                        </p>
                        <button onclick="window.migrationChartInstance.update()" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-600 border border-primary/50 font-semibold transition">Refresh Chart Data</button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- JavaScript Logic -->
    <script>
        let risks = [
            { 
                id: 1, 
                hazard: 'Major Cyber Attack (Ransomware)', 
                likelihood: 4, 
                impact: 5, 
                controls: 'Antivirus, Backup/Recovery Plan, Staff Training',
                effectiveness: 2 
            },
            { 
                id: 2, 
                hazard: 'Prolonged Power Failure (24hr+)', 
                likelihood: 3, 
                impact: 4, 
                controls: 'UPS system for servers, Diesel Generator (12 hr capacity)',
                effectiveness: 4 
            },
            { 
                id: 3, 
                hazard: 'Key Personnel Absence (Mass Sickness)', 
                likelihood: 3, 
                impact: 3, 
                controls: 'Cross-training, succession planning',
                effectiveness: 3
            }
        ];
        let nextRiskId = 4;
        let migrationChartInstance;
        
        function getRiskLevelClass(score) {
            if (score > 12) return 'risk-high';
            if (score > 6) return 'risk-medium';
            if (score > 1) return 'risk-low';
            return 'risk-vlow';
        }

        function calculateScore(likelihood, impact, effectiveness, type = 'inherent') {
            const inherent = likelihood * impact;
            if (type === 'inherent') return inherent;
            const reductionFactor = (effectiveness - 1) / 5;
            const residual = inherent * (1 - reductionFactor);
            return Math.round(residual);
        }

        function getDropdown(id, currentValue) {
            const options = [
                { val: 1, text: '1' },
                { val: 2, text: '2' },
                { val: 3, text: '3' },
                { val: 4, text: '4' },
                { val: 5, text: '5' }
            ];
            let html = `<select data-risk-id="${id}" class="risk-selector text-xs bg-gray-700 border-none p-1 rounded-md" onchange="updateRisk(${id})">`;
            options.forEach(opt => {
                html += `<option value="${opt.val}" ${opt.val === currentValue ? 'selected' : ''}>${opt.text}</option>`;
            });
            html += `</select>`;
            return html;
        }

        function renderRiskTable() {
            const tbody = document.getElementById('risk-body');
            tbody.innerHTML = '';
            
            let highInherentCount = 0;
            let migratedToLowCount = 0;
            let totalEffectiveness = 0;

            risks.forEach(risk => {
                const inherentScore = calculateScore(risk.likelihood, risk.impact, 0, 'inherent');
                const residualScore = calculateScore(risk.likelihood, risk.impact, risk.effectiveness, 'residual');
                
                if (inherentScore > 12) highInherentCount++;
                if (residualScore < 6) migratedToLowCount++;
                totalEffectiveness += risk.effectiveness;

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-700 transition-colors duration-150';
                tr.setAttribute('data-risk-row-id', risk.id);

                tr.innerHTML = `
                    <td class="px-3 py-2 font-medium text-gray-100">${risk.hazard}</td>
                    <td class="px-3 py-2">${getDropdown(risk.id, risk.likelihood)}</td>
                    <td class="px-3 py-2">${getDropdown(risk.id, risk.impact)}</td>
                    <td class="px-3 py-2 text-center">
                        <span class="${getRiskLevelClass(inherentScore)}">${inherentScore}</span>
                    </td>
                    <td class="px-3 py-2">
                        <textarea data-risk-id="${risk.id}" class="risk-controls w-full h-12 text-xs bg-gray-700" onchange="updateRisk(${risk.id}, 'controls')">${risk.controls}</textarea>
                    </td>
                    <td class="px-3 py-2 text-center">
                        <select data-risk-id="${risk.id}" data-type="effectiveness" class="risk-effectiveness text-xs bg-gray-700 border-none p-1 rounded-md" onchange="updateRisk(${risk.id})">
                            <option value="1" ${risk.effectiveness === 1 ? 'selected' : ''}>1</option>
                            <option value="2" ${risk.effectiveness === 2 ? 'selected' : ''}>2</option>
                            <option value="3" ${risk.effectiveness === 3 ? 'selected' : ''}>3</option>
                            <option value="4" ${risk.effectiveness === 4 ? 'selected' : ''}>4</option>
                            <option value="5" ${risk.effectiveness === 5 ? 'selected' : ''}>5</option>
                        </select>
                    </td>
                    <td class="px-3 py-2 text-center">
                        <span class="${getRiskLevelClass(residualScore)}">${residualScore}</span>
                    </td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="deleteRisk(${risk.id})" class="text-red-500 hover:text-red-400 text-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('high-risk-count').innerText = highInherentCount;
            document.getElementById('migrated-risk-count').innerText = migratedToLowCount;
            const avgEff = risks.length > 0 ? (totalEffectiveness / risks.length).toFixed(1) : 0;
            document.getElementById('avg-control-eff').innerText = `${avgEff} / 5.0`;

            updateMigrationChart();
        }

        function updateRisk(id, field = null) {
            const riskIndex = risks.findIndex(r => r.id === id);
            if (riskIndex === -1) return;

            const tr = document.querySelector(`[data-risk-row-id="${id}"]`);
            if (!tr) return;
            
            if (field === 'controls') {
                risks[riskIndex].controls = tr.querySelector('.risk-controls').value;
            } else {
                const selectors = tr.querySelectorAll('.risk-selector');
                risks[riskIndex].likelihood = parseInt(selectors[0].value);
                risks[riskIndex].impact = parseInt(selectors[1].value);
                risks[riskIndex].effectiveness = parseInt(tr.querySelector('.risk-effectiveness').value);
            }
            
            renderRiskTable(); 
        }

        function addRisk() {
            const hazardName = document.getElementById('new-hazard').value.trim();
            if (hazardName) {
                risks.push({
                    id: nextRiskId++,
                    hazard: hazardName,
                    likelihood: 3,
                    impact: 3,
                    controls: 'TBD - Treatment plan pending',
                    effectiveness: 1
                });
                document.getElementById('new-hazard').value = '';
                renderRiskTable();
            }
        }

        function deleteRisk(id) {
            risks = risks.filter(r => r.id !== id);
            renderRiskTable();
        }

        function updateMigrationChart() {
            const sortedRisks = [...risks].sort((a, b) => {
                const scoreA = calculateScore(a.likelihood, a.impact, 0, 'inherent');
                const scoreB = calculateScore(b.likelihood, b.impact, 0, 'inherent');
                return scoreB - scoreA;
            });

            const labels = sortedRisks.slice(0, 5).map(r => r.hazard.split('(')[0].trim());
            const inherentScores = sortedRisks.slice(0, 5).map(r => calculateScore(r.likelihood, r.impact, 0, 'inherent'));
            const residualScores = sortedRisks.slice(0, 5).map(r => calculateScore(r.likelihood, r.impact, r.effectiveness, 'residual'));

            if (migrationChartInstance) {
                migrationChartInstance.data.labels = labels;
                migrationChartInstance.data.datasets[0].data = inherentScores;
                migrationChartInstance.data.datasets[1].data = residualScores;
                migrationChartInstance.update();
                return;
            }

            const ctx = document.getElementById('migrationChart').getContext('2d');
            migrationChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Inherent Risk (Before Controls)',
                            data: inherentScores,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: 'Residual Risk (After Controls)',
                            data: residualScores,
                            backgroundColor: 'rgba(0, 247, 255, 0.8)',
                            borderColor: 'rgba(0, 247, 255, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 25,
                            title: { display: true, text: 'Risk Score (L x I)', color: '#a0a0a0', font: { family: 'Inter', size: 14 } },
                            ticks: { color: '#a0a0a0', font: { family: 'Inter' } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            title: { display: true, text: 'Top Priority Risks', color: '#a0a0a0', font: { family: 'Inter', size: 14 } },
                            ticks: { color: '#a0a0a0', font: { family: 'Inter' } },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e5e7eb',
                                font: { family: 'Inter' }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            bodyFont: { family: 'Inter' },
                            titleFont: { family: 'Inter', weight: 'bold' }
                        }
                    }
                }
            });
            window.migrationChartInstance = migrationChartInstance;
        }

        function navTo(sectionId) {
            document.querySelectorAll('.content-section').forEach(el => {
                el.classList.add('hidden');
            });
            
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }

            document.getElementById('main-scroll').scrollTop = 0;

            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-gray-700', 'border-primary');
                el.classList.add('border-primary/0');
            });
            
            const activeNav = document.querySelector(`[onclick="navTo('${sectionId}')"]`);
            if(activeNav) {
                activeNav.classList.add('bg-gray-700', 'border-primary');
                activeNav.classList.remove('border-primary/0');
            }

            if (sectionId === 'review') {
                updateMigrationChart();
                if (window.migrationChartInstance) window.migrationChartInstance.resize(); 
            }

            if(window.innerWidth < 768) {
                toggleMobileMenu();
            }
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('backdrop');

            const isHidden = sidebar.classList.contains('-translate-x-full');

            if (isHidden) {
                sidebar.classList.remove('-translate-x-full');
                backdrop.classList.add('active');
            } else {
                sidebar.classList.add('-translate-x-full');
                backdrop.classList.remove('active');
            }
        }

        document.getElementById('mobile-menu-btn').addEventListener('click', toggleMobileMenu);

        window.onload = function() {
            renderRiskTable();
            navTo('context');
        };
    </script>
</body>
</html>
