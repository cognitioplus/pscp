<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Risk Assessment</title>
    
    <!-- Google Fonts Imports -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

    <!-- Tailwind Config for Custom Colors and Inter Font -->
    <script>
        (function() {
            // Define light mode colors: Primary is now a deep blue for contrast
            const LIGHT_ACCENT = '#1e3a8a'; // Deep Blue (Blue-900)
            const LIGHT_TEXT = '#374151'; // Dark Slate Gray
            const LIGHT_BG = '#f9fafb'; // Very Light Gray

            if (typeof tailwind !== 'undefined') {
                tailwind.config = {
                    theme: {
                        extend: {
                            fontFamily: {
                                sans: ['Inter', 'sans-serif'],
                                poppins: ['Poppins', 'sans-serif'],
                                montserrat: ['Montserrat', 'sans-serif'], // Added Montserrat
                            },
                            colors: {
                                primary: LIGHT_ACCENT, // DEEP BLUE (Main Accent)
                                secondary: LIGHT_TEXT, // Dark Gray (Text Color)
                                danger: '#ef4444', // Red (High Risk)
                                warning: '#f97316', // Orange (Medium Risk)
                                safe: '#10b981', // Emerald Green (Mitigation Success)
                                context: '#ffffff', // Card/Panel Background (White)
                                background: LIGHT_BG, // Body Background (Light Gray)
                            }
                        }
                    }
                }
            }
        })();
    </script>

    <style>
        /* --- CORE LIGHT MODE STYLE --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--colors-background, #f9fafb); /* Use light background */
            color: var(--colors-secondary, #374151); /* Use dark text color */
        }
        
        /* Fallback for CSS variables if Tailwind config isn't fully loaded */
        :root {
            --color-primary: #1e3a8a;
            --color-secondary: #374151;
            --color-danger: #ef4444;
            --color-warning: #f97316;
            --color-context: #ffffff;
        }

        /* --- Custom Scrollbar (Light Mode) --- */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #e5e7eb; /* Light track */
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-primary); 
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #102e70; /* Darker blue on hover */
        }
        
        /* Utility for Highlighting Risk Levels (High Contrast Light Mode) */
        .risk-high { background-color: #fee2e2; color: var(--color-danger); font-weight: 700; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--color-danger); } 
        .risk-medium { background-color: #ffedd5; color: var(--color-warning); font-weight: 700; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--color-warning); }
        .risk-low { background-color: #d1fae5; color: var(--color-safe, #10b981); font-weight: 700; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--color-safe, #10b981); }
        .risk-vlow { background-color: #f3f4f6; color: var(--color-secondary); font-weight: 700; padding: 4px 8px; border-radius: 4px; border: 1px solid #d1d5db; }

        /* Custom Input/Table Styling for Light Theme */
        input[type="text"], textarea, select {
            border-radius: 0.375rem;
            border: 1px solid #d1d5db; /* Light gray border */
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            width: 100%;
            background-color: var(--color-context); 
            color: var(--color-secondary);
            transition: border-color 0.2s, box-shadow 0.2s;
            font-family: 'Inter', sans-serif;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.4); /* Blue glow on focus */
        }

        /* Main table hover effect */
        #risk-table tbody tr:hover {
            background-color: #f3f4f6; /* Very light hover */
            transition: background-color 0.2s;
        }
        
        /* --- Interactive Card Hover Effects (Light Mode) --- */
        .interactive-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Default subtle shadow */
            border: 1px solid #e5e7eb; /* Base border for structure */
        }

        .interactive-card:hover {
            transform: translateY(-2px); /* Subtle lift */
            box-shadow: 0 6px 16px rgba(30, 58, 138, 0.15); /* Primary blue shadow on hover */
            border-color: var(--color-primary);
        }
        
        /* Nav Item Active State */
        .active-nav {
            background-color: #e5e7eb !important; /* Light gray background */
            border-left-color: var(--color-primary) !important;
            color: var(--color-primary) !important; /* Blue text */
        }
        .active-nav .text-primary {
            color: var(--color-primary) !important; /* Ensure icon is primary blue */
        }
        
        /* Header Title Font - Montserrat */
        .header-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
        }
        
        /* Section Header Font - Poppins (Kept for visual break) */
        .section-header {
            font-family: 'Poppins', sans-serif;
        }
        
        /* Button Font - Montserrat */
        .btn-montserrat {
            font-family: 'Montserrat', sans-serif;
        }

        /* --- Chart Container Specifics --- */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 400px;
            max-height: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
        
        /* Section Transition */
        .content-section {
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }
        .content-section.hidden {
            display: none;
            opacity: 0;
        }
    </style>
</head>
<body class="antialiased h-screen flex overflow-hidden">

    <!-- Backdrop for Mobile Sidebar -->
    <div id="backdrop" class="backdrop-overlay" onclick="toggleMobileMenu()"></div>


    <!-- Sidebar Navigation (Fixed on Desktop) -->
    <aside id="sidebar" class="bg-gray-100 text-gray-700 w-64 flex-shrink-0 flex flex-col transition-transform duration-300 transform -translate-x-full md:translate-x-0 fixed md:sticky top-0 h-full z-40 border-r border-gray-300 shadow-lg">
    
        
        <nav class="flex-1 overflow-y-auto py-4">
            <ul class="space-y-1">
                <li>
                    <button onclick="navTo('context')" class="nav-item w-full text-left px-6 py-3 flex items-center gap-3 hover:bg-gray-200 transition-colors border-l-4 rounded-r-full active-nav bg-gray-200 border-l-4 border-primary text-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary lucide lucide-git-branch"><line x1="6" x2="6" y1="3" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9c-3.88 0-7.35 1.72-9.6 4.34"/></svg>
                        <span class="font-semibold text-sm btn-montserrat">1. Context Establishment</span>
                    </button>
                </li>
                <li>
                    <button onclick="navTo('assessment')" class="nav-item w-full text-left px-6 py-3 flex items-center gap-3 hover:bg-gray-200 transition-colors border-l-4 border-transparent rounded-r-full text-gray-700" id="nav-assessment">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary lucide lucide-bar-chart-3"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                        <span class="font-semibold text-sm btn-montserrat">2. Risk Assessment</span>
                    </button>
                </li>
                <li>
                    <button onclick="navTo('evaluation')" class="nav-item w-full text-left px-6 py-3 flex items-center gap-3 hover:bg-gray-200 transition-colors border-l-4 border-transparent rounded-r-full text-gray-700" id="nav-evaluation">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary lucide lucide-shield-check"><path d="M20 13c0 5-8 7-8 7s-8-2-8-7V5l8-3 8 3z"/><path d="m9 12 2 2 4-4"/></svg>
                        <span class="font-semibold text-sm btn-montserrat">3. Control Evaluation</span>
                    </button>
                </li>
                <li>
                    <button onclick="navTo('review')" class="nav-item w-full text-left px-6 py-3 flex items-center gap-3 hover:bg-gray-200 transition-colors border-l-4 border-transparent rounded-r-full text-gray-700" id="nav-review">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary lucide lucide-line-chart"><path d="M3 3v18h18"/><path d="m18 12-6-6-4 4-3-3"/></svg>
                        <span class="font-semibold text-sm btn-montserrat">4. Migration & Review</span>
                    </button>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content Area -->
    <div class="flex-1 overflow-y-auto w-full md:ml-0">
        <!-- Sticky Header - Light Mode -->
        <header class="sticky top-0 z-10 bg-white/95 backdrop-blur-sm border-b-2 border-gray-200 p-4 md:p-6 shadow-md">
            <h2 class="text-3xl header-title text-primary tracking-widest">RISK ASSESSMENT WORKBENCH</h2>
            <p class="mt-1 text-gray-500 max-w-4xl text-sm font-sans">
                Real-time risk posture evaluation aligned with ISO 31000 and PSCP requirements.
            </p>
        </header>

        <!-- Scrollable Main Body -->
        <main class="relative w-full p-6 md:p-10" id="main-scroll">
            <div class="max-w-7xl mx-auto">
                
                <!-- SECTION 1: CONTEXT ESTABLISHMENT -->
                <section id="context" class="content-section">
                    <h3 class="text-2xl section-header text-primary mb-6 pb-2 border-b border-gray-300">1. Context Establishment (Scope & Criteria)</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-context p-8 rounded-xl shadow-lg border border-primary/50 interactive-card">
                            <h4 class="font-sans text-xl mb-4 text-secondary flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary lucide lucide-compass"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg> Organizational Scope</h4>
                            <p class="text-sm text-gray-500 mb-6 font-sans">Define the boundaries and critical functions under assessment for continuity planning.</p>
                            
                            <label class="block text-sm font-semibold text-primary mb-1">Assessment Name</label>
                            <input type="text" id="assessment-name" value="PSCP Q3 Risk Review" class="mb-6 border-gray-300">
                            
                            <label class="block text-sm font-semibold text-primary mb-1">Critical Function Assessed</label>
                            <textarea id="assessment-scope" rows="4" class="w-full border-gray-300">Emergency Response and Public Notification Services, including IT Infrastructure and Key Personnel availability.</textarea>

                            <button onclick="navTo('assessment')" class="mt-8 bg-primary text-white px-6 py-3 rounded-xl btn-montserrat font-bold hover:bg-blue-700 transition shadow-lg shadow-primary/30">
                                INITIALIZE ASSESSMENT →
                            </button>
                        </div>

                        <div class="bg-context p-6 rounded-xl shadow-lg border border-gray-300 interactive-card">
                            <h4 class="font-sans text-xl mb-4 text-secondary flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-warning lucide lucide-scaling"><path d="M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18Z"/><path d="M7 10h5v5"/></svg> Risk Evaluation Criteria (5x5)</h4>
                            <p class="text-sm text-gray-500 mb-4 font-sans">Inherent Risk Score = Likelihood (L) x Impact (I). Max: 25.</p>
                            
                            <!-- Risk Matrix Display - Sharper Grid -->
                            <div class="grid grid-cols-6 gap-px text-center text-xs font-semibold border border-primary bg-white overflow-hidden rounded-lg">
                                <div class="col-span-1 bg-gray-200 text-primary p-1 border-r border-primary font-sans">L/I</div>
                                <div class="col-span-1 bg-gray-200 text-primary p-1 font-sans">1 (Insig)</div>
                                <div class="col-span-1 bg-gray-200 text-primary p-1 font-sans">2 (Minor)</div>
                                <div class="col-span-1 bg-gray-200 text-primary p-1 font-sans">3 (Mod)</div>
                                <div class="col-span-1 bg-gray-200 text-primary p-1 font-sans">4 (Major)</div>
                                <div class="col-span-1 bg-gray-200 text-primary p-1 font-sans">5 (Catas)</div>

                                <div class="col-span-1 bg-gray-200 text-primary p-1 border-r border-primary font-sans">5 (Almost C.)</div>
                                <div class="col-span-5 grid grid-cols-5 text-secondary">
                                    <div class="p-1 risk-medium">5</div>
                                    <div class="p-1 risk-high">10</div>
                                    <div class="p-1 risk-high">15</div>
                                    <div class="p-1 risk-high">20</div>
                                    <div class="p-1 risk-high">25</div>
                                </div>

                                <div class="col-span-1 bg-gray-200 text-primary p-1 border-r border-primary font-sans">4 (Likely)</div>
                                <div class="col-span-5 grid grid-cols-5 text-secondary">
                                    <div class="p-1 risk-low">4</div>
                                    <div class="p-1 risk-medium">8</div>
                                    <div class="p-1 risk-high">12</div>
                                    <div class="p-1 risk-high">16</div>
                                    <div class="p-1 risk-high">20</div>
                                </div>
                                
                                <div class="col-span-1 bg-gray-200 text-primary p-1 border-r border-primary font-sans">3 (Possible)</div>
                                <div class="col-span-5 grid grid-cols-5 text-secondary">
                                    <div class="p-1 risk-low">3</div>
                                    <div class="p-1 risk-medium">6</div>
                                    <div class="p-1 risk-medium">9</div>
                                    <div class="p-1 risk-high">12</div>
                                    <div class="p-1 risk-high">15</div>
                                </div>
                                
                                <div class="col-span-1 bg-gray-200 text-primary p-1 border-r border-primary font-sans">2 (Unlikely)</div>
                                <div class="col-span-5 grid grid-cols-5 text-secondary">
                                    <div class="p-1 risk-vlow">2</div>
                                    <div class="p-1 risk-low">4</div>
                                    <div class="p-1 risk-medium">6</div>
                                    <div class="p-1 risk-medium">8</div>
                                    <div class="p-1 risk-medium">10</div>
                                </div>
                                
                                <div class="col-span-1 bg-gray-200 text-primary p-1 border-r border-primary font-sans">1 (Rare)</div>
                                <div class="col-span-5 grid grid-cols-5 text-secondary">
                                    <div class="p-1 risk-vlow">1</div>
                                    <div class="p-1 risk-vlow">2</div>
                                    <div class="p-1 risk-low">3</div>
                                    <div class="p-1 risk-low">4</div>
                                    <div class="p-1 risk-medium">5</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SECTION 2 & 3: RISK ASSESSMENT & CONTROL EVALUATION -->
                <section id="assessment" class="content-section hidden">
                    <h3 class="text-2xl section-header text-primary mb-6 pb-2 border-b border-gray-300">2. Assessment & 3. Control Evaluation</h3>
                    <p class="text-gray-500 mb-6 text-sm font-sans">
                        Evaluate **Inherent Risk** (before controls) and then rate existing control effectiveness to calculate the **Residual Risk** (risk remaining).
                    </p>

                    <!-- KPI Cards (Light Mode) -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 font-sans mb-8">
                        <div class="bg-context p-5 rounded-xl shadow-lg border-l-4 border-danger hover:shadow-danger/20 transition-shadow interactive-card kpi-card">
                            <p class="text-xs uppercase text-danger font-semibold flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-danger lucide lucide-alert-triangle"><path d="m21.73 18-9-15-9 15z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg> High Inherent Risks (Score > 12)</p>
                            <p id="high-risk-count" class="text-4xl font-sans text-danger mt-1 font-extrabold">0</p>
                        </div>
                        <div class="bg-context p-5 rounded-xl shadow-lg border-l-4 border-warning hover:shadow-warning/20 transition-shadow interactive-card kpi-card">
                            <p class="text-xs uppercase text-warning font-semibold flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-warning lucide lucide-gauge"><path d="M20.1 9a9 9 0 1 0-16.2 0"/><path d="M12 14v4"/><path d="M10.5 4.5l3 3"/></svg> Average Control Effectiveness</p>
                            <p id="avg-control-eff" class="text-4xl font-sans text-warning mt-1 font-extrabold">0 / 5.0</p>
                        </div>
                        <div class="bg-context p-5 rounded-xl shadow-lg border-l-4 border-safe hover:shadow-safe/20 transition-shadow interactive-card kpi-card">
                            <p class="text-xs uppercase text-safe font-semibold flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-safe lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg> Risks Migrated to Low (Residual Score < 6)</p>
                            <p id="migrated-risk-count" class="text-4xl font-sans text-safe mt-1 font-extrabold">0</p>
                        </div>
                    </div>
                    
                    <!-- Risk Table -->
                    <div class="bg-context p-6 rounded-xl shadow-lg border border-gray-300 overflow-x-auto mb-6">
                        <table id="risk-table" class="min-w-full divide-y divide-gray-200 font-sans">
                            <thead class="bg-gray-100 text-xs uppercase tracking-wider text-primary sticky top-0 z-5 border-b-2 border-primary/20">
                                <tr>
                                    <th class="px-3 py-3 text-left text-secondary">Hazard/Threat</th>
                                    <th class="px-3 py-3 text-left w-24 text-secondary">L (1-5)</th>
                                    <th class="px-3 py-3 text-left w-24 text-secondary">I (1-5)</th>
                                    <th class="px-3 py-3 text-center w-24 text-secondary">Inherent</th>
                                    <th class="px-3 py-3 text-left text-secondary">Controls / Treatment</th>
                                    <th class="px-3 py-3 text-center w-28 text-secondary">Eff (1-5)</th>
                                    <th class="px-3 py-3 text-center w-24 text-secondary">Residual</th>
                                    <th class="px-3 py-3 text-center text-secondary">Action</th>
                                </tr>
                            </thead>
                            <tbody id="risk-body" class="divide-y divide-gray-200 text-sm text-gray-700">
                                <!-- Rows generated by JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Add Risk Section -->
                    <div class="p-4 bg-gray-100 rounded-xl border border-gray-300 shadow-lg interactive-card">
                        <div class="flex flex-col sm:flex-row gap-4 items-center">
                            <input type="text" id="new-hazard" placeholder="Enter new hazard (e.g., Data Breach via API Misconfiguration)" class="flex-1 border-gray-300">
                            <button onclick="addRisk()" class="w-full sm:w-auto bg-primary text-white px-6 py-2 rounded-xl btn-montserrat font-bold hover:bg-blue-700 transition shrink-0 shadow-md shadow-primary/30">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1 lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                                Add Risk
                            </button>
                        </div>
                    </div>
                    <button onclick="navTo('review')" class="mt-6 bg-primary text-white px-6 py-3 rounded-xl btn-montserrat font-bold hover:bg-blue-700 transition shadow-lg shadow-primary/30 float-right">
                        PROCEED TO REVIEW →
                    </button>
                    <div class="clearfix"></div>
                </section>

                <!-- SECTION 4: MIGRATION & REVIEW -->
                <section id="review" class="content-section hidden">
                    <h3 class="text-2xl section-header text-primary mb-6 pb-2 border-b border-gray-300">4. Risk Migration & Review</h3>
                    <p class="text-gray-500 mb-8 font-sans text-sm">
                        Review the risk migration from Inherent to Residual risk (Top 5). Large gaps indicate effective controls, while small gaps highlight areas requiring new **Treatment Plans**.
                    </p>

                    <!-- Chart Container (chart-container class applied) -->
                    <div class="chart-container bg-context p-6 rounded-xl shadow-lg border border-gray-300 interactive-card">
                        <canvas id="migrationChart"></canvas>
                    </div>

                    <div class="mt-8 p-6 bg-gray-100 rounded-xl border border-gray-300 shadow-lg interactive-card">
                        <h4 class="font-sans text-xl mb-3 text-primary flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary lucide lucide-lightbulb"><path d="M15 14c.2-.58.2-1.2 0-2c-.2-.58-.5-1.07-1-1.42V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v6.58c-.5.35-.8 1.05-1 1.42-.2.58-.2 1.2 0 2a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2z"/><path d="M12 21h4"/></svg> ANALYSIS & RECOMMENDATIONS</h4>
                        <p class="text-sm text-gray-700 leading-relaxed font-sans">
                            Focus immediate attention on risks where the **Residual Risk Score** remains above 9. These are the highest priority items for developing detailed, resource-allocated **Treatment Plans** to further mitigate continuity threats. Utilize the `Add Risk` feature to log new hazards as they are identified.
                        </p>
                        <button onclick="window.migrationChartInstance.update()" class="mt-4 bg-gray-300 text-secondary px-4 py-2 rounded-lg text-sm hover:bg-gray-400 border border-gray-400 btn-montserrat font-semibold transition">REFRESH DATA DISPLAY</button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // Data Structure for Risks
        let risks = [
            { 
                id: 1, 
                hazard: 'Major Cyber Attack (Ransomware)', 
                likelihood: 4, 
                impact: 5, 
                controls: 'Antivirus, Backup/Recovery Plan, Staff Training',
                effectiveness: 2 
            },
            { 
                id: 2, 
                hazard: 'Prolonged Power Failure (24hr+)', 
                likelihood: 3, 
                impact: 4, 
                controls: 'UPS system for servers, Diesel Generator (12 hr capacity)',
                effectiveness: 4 
            },
            { 
                id: 3, 
                hazard: 'Key Personnel Absence (Mass Sickness)', 
                likelihood: 3, 
                impact: 3, 
                controls: 'Cross-training, succession planning',
                effectiveness: 3
            }
        ];
        let nextRiskId = 4;
        let migrationChartInstance;
        
        // --- 1. Utility Functions ---
        function getRiskLevelClass(score) {
            if (score > 12) return 'risk-high';
            if (score > 6) return 'risk-medium';
            if (score > 1) return 'risk-low';
            return 'risk-vlow';
        }

        function calculateScore(likelihood, impact, effectiveness, type = 'inherent') {
            const inherent = likelihood * impact;
            if (type === 'inherent') return inherent;
            
            // Effectiveness rating (1=None, 5=Excellent) reduces the inherent risk
            // Reduction Factor: 0% at Eff=1, 80% at Eff=5.
            const reductionFactor = (effectiveness - 1) / 5; // Max 0.8
            const residual = inherent * (1 - reductionFactor);

            return Math.round(residual);
        }

        function getDropdown(id, currentValue, type) {
            const options = [
                { val: 1, text: '1' },
                { val: 2, text: '2' },
                { val: 3, text: '3' },
                { val: 4, text: '4' },
                { val: 5, text: '5' }
            ];
            // Adjusted classes for consistency
            let html = `<select data-risk-id="${id}" data-type="${type}" class="risk-selector text-xs bg-white border border-gray-300 p-1 rounded-md text-secondary" onchange="updateRisk(${id})">`;
            options.forEach(opt => {
                html += `<option value="${opt.val}" ${opt.val === currentValue ? 'selected' : ''}>${opt.text}</option>`;
            });
            html += `</select>`;
            return html;
        }

        // --- 2. Main Rendering & Update Logic ---

        function renderRiskTable() {
            const tbody = document.getElementById('risk-body');
            tbody.innerHTML = '';
            
            let highInherentCount = 0;
            let migratedToLowCount = 0;
            let totalEffectiveness = 0;

            risks.forEach(risk => {
                const inherentScore = calculateScore(risk.likelihood, risk.impact, 0, 'inherent');
                const residualScore = calculateScore(risk.likelihood, risk.impact, risk.effectiveness, 'residual');
                
                if (inherentScore > 12) highInherentCount++;
                if (residualScore < 6) migratedToLowCount++;
                totalEffectiveness += risk.effectiveness;

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-100 transition-colors duration-150 border-b border-gray-200';
                tr.setAttribute('data-risk-row-id', risk.id); // Added ID for easier row lookup

                tr.innerHTML = `
                    <td class="px-3 py-2 font-medium text-secondary">${risk.hazard}</td>
                    <td class="px-3 py-2">${getDropdown(risk.id, risk.likelihood, 'likelihood')}</td>
                    <td class="px-3 py-2">${getDropdown(risk.id, risk.impact, 'impact')}</td>
                    <td class="px-3 py-2 text-center">
                        <span class="${getRiskLevelClass(inherentScore)}">${inherentScore}</span>
                    </td>
                    <td class="px-3 py-2">
                        <textarea data-risk-id="${risk.id}" class="risk-controls w-full h-12 text-xs bg-white border border-gray-300 text-secondary" onchange="updateRisk(${risk.id}, 'controls')">${risk.controls}</textarea>
                    </td>
                    <td class="px-3 py-2 text-center">
                        <select data-risk-id="${risk.id}" data-type="effectiveness" class="risk-effectiveness text-xs bg-white border border-gray-300 p-1 rounded-md text-secondary" onchange="updateRisk(${id})">
                            <option value="1" ${risk.effectiveness === 1 ? 'selected' : ''}>1</option>
                            <option value="2" ${risk.effectiveness === 2 ? 'selected' : ''}>2</option>
                            <option value="3" ${risk.effectiveness === 3 ? 'selected' : ''}>3</option>
                            <option value="4" ${risk.effectiveness === 4 ? 'selected' : ''}>4</option>
                            <option value="5" ${risk.effectiveness === 5 ? 'selected' : ''}>5</option>
                        </select>
                    </td>
                    <td class="px-3 py-2 text-center">
                        <span class="${getRiskLevelClass(residualScore)}">${residualScore}</span>
                    </td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="deleteRisk(${risk.id})" class="text-red-500 hover:text-red-400 text-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Update Dashboard metrics
            document.getElementById('high-risk-count').innerText = highInherentCount;
            document.getElementById('migrated-risk-count').innerText = migratedToLowCount;
            const avgEff = risks.length > 0 ? (totalEffectiveness / risks.length).toFixed(1) : 0;
            document.getElementById('avg-control-eff').innerText = `${avgEff} / 5.0`;

            // Rerender Chart
            updateMigrationChart();
        }

        function updateRisk(id, field = null) {
            const riskIndex = risks.findIndex(r => r.id === id);
            if (riskIndex === -1) return;

            // Find the correct row using the custom attribute
            const tr = document.querySelector(`[data-risk-row-id="${id}"]`);
            if (!tr) return;
            
            if (field === 'controls') {
                risks[riskIndex].controls = tr.querySelector('.risk-controls').value;
            } else {
                // Find all risk selectors (Likelihood/Impact) and the specific effectiveness selector
                const likelihoodSelector = tr.querySelector('select[data-type="likelihood"]');
                const impactSelector = tr.querySelector('select[data-type="impact"]');
                
                // Get Likelihood 
                risks[riskIndex].likelihood = parseInt(likelihoodSelector.value);
                
                // Get Impact 
                risks[riskIndex].impact = parseInt(impactSelector.value);

                // Get Effectiveness (the one with the unique class)
                risks[riskIndex].effectiveness = parseInt(tr.querySelector('.risk-effectiveness').value);
            }
            
            renderRiskTable(); 
        }

        function addRisk() {
            const hazardName = document.getElementById('new-hazard').value.trim();
            if (hazardName) {
                risks.push({
                    id: nextRiskId++,
                    hazard: hazardName,
                    likelihood: 3,
                    impact: 3,
                    controls: 'TBD - Treatment plan pending',
                    effectiveness: 1
                });
                document.getElementById('new-hazard').value = '';
                renderRiskTable();
            }
        }

        function deleteRisk(id) {
            risks = risks.filter(r => r.id !== id);
            renderRiskTable();
        }

        // --- 3. Chart Logic ---

        function updateMigrationChart() {
            // Sort risks by Inherent Score descending, then take top 5
            const sortedRisks = [...risks].sort((a, b) => {
                const scoreA = calculateScore(a.likelihood, a.impact, 0, 'inherent');
                const scoreB = calculateScore(b.likelihood, b.impact, 0, 'inherent');
                return scoreB - scoreA;
            });

            const labels = sortedRisks.slice(0, 5).map(r => r.hazard.split('(')[0].trim());
            const inherentScores = sortedRisks.slice(0, 5).map(r => calculateScore(r.likelihood, r.impact, 0, 'inherent'));
            const residualScores = sortedRisks.slice(0, 5).map(r => calculateScore(r.likelihood, r.impact, r.effectiveness, 'residual'));

            if (migrationChartInstance) {
                migrationChartInstance.data.labels = labels;
                migrationChartInstance.data.datasets[0].data = inherentScores;
                migrationChartInstance.data.datasets[1].data = residualScores;
                migrationChartInstance.options.scales.y.grid.color = 'rgba(0, 0, 0, 0.1)'; // Update grid color for light mode
                migrationChartInstance.update();
                return;
            }

            const ctx = document.getElementById('migrationChart').getContext('2d');
            migrationChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Inherent Risk (Before Controls)',
                            data: inherentScores,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)', // Red
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: 'Residual Risk (After Controls)',
                            data: residualScores,
                            backgroundColor: 'rgba(30, 58, 138, 0.8)', // Deep Blue Primary
                            borderColor: 'rgba(30, 58, 138, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 25,
                            title: { display: true, text: 'Risk Score (L x I)', color: '#6b7280', font: { family: 'Inter', size: 14 } },
                            ticks: { color: '#4b5563', font: { family: 'Inter' } },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' } /* Light Grid Lines */
                        },
                        x: {
                            title: { display: true, text: 'Top Priority Risks', color: '#6b7280', font: { family: 'Inter', size: 14 } },
                            ticks: { color: '#4b5563', font: { family: 'Inter' } },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#374151', // Legend text color
                                font: { family: 'Inter' }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            bodyFont: { family: 'Inter' },
                            titleFont: { family: 'Inter', weight: 'bold' }
                        }
                    }
                }
            });
            window.migrationChartInstance = migrationChartInstance;
        }

        // --- 4. Navigation Logic ---
        function navTo(sectionId) {
            // Remove active classes from all sections and hide them
            document.querySelectorAll('.content-section').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Show the target section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }

            document.getElementById('main-scroll').scrollTop = 0;

            // Update sidebar active state
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active-nav', 'bg-gray-200', 'border-primary', 'text-primary');
                el.classList.add('border-transparent', 'text-gray-700');
            });
            
            const activeNav = document.querySelector(`[onclick="navTo('${sectionId}')"]`);
            if(activeNav) {
                activeNav.classList.add('active-nav', 'bg-gray-200', 'border-primary', 'text-primary');
                activeNav.classList.remove('border-transparent', 'text-gray-700');
            }

            // Chart update on entering the Review section
            if (sectionId === 'review') {
                updateMigrationChart();
                // Ensure chart is responsive on section change
                if (window.migrationChartInstance) window.migrationChartInstance.resize(); 
            }

            // Close mobile menu if open
            if(window.innerWidth < 768) {
                toggleMobileMenu();
            }
        }

        // Mobile Menu Toggle Logic
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('backdrop');

            const isHidden = sidebar.classList.contains('-translate-x-full');

            if (isHidden) {
                sidebar.classList.remove('-translate-x-full');
                backdrop.classList.add('active');
            } else {
                sidebar.classList.add('-translate-x-full');
                backdrop.classList.remove('active');
            }
        }

        document.getElementById('mobile-menu-btn').addEventListener('click', toggleMobileMenu);

        // Initial setup
        window.onload = function() {
            renderRiskTable();
            navTo('context');
        };
    </script>
</body>
</html>
